# 如何设计一个可拓展的数据表结构

现在正面临着一个需求，是关于工厂监控指标的设计，不同的工厂需要监控不同的指标，例如温度、阈值、气压、烟雾浓度等。而如果将这些指标都集成为结构体并使用独立的表格进行判断，会导致在项目复用推广的过程中积累很多冗余的业务模型。笔者思考是否有更好的方式来组织这些代码。

## 需求分析

我们需要存储的内容有，生产环境对于指标的限制条件，以及由机器人上传的记录数据，也就是这里就需要两张表。笔者借鉴表单的格式来组织数据，表头的数据格式是较为固定的，包括标准/指标的名字，描述，警报阈值，监控的数据类型(`string, int, float, interface{}`)。表体的数据就要存储由机器人汇报的记录，但是这个表的数据结构在不同场景的形式都不一样，我们很难为每一个模型编写代码。

## 方案构思

首先我们可以在数据库中预留一些空字段用于这些数据的插入，但是这个方案一方面在面临预留空间不够时难以调整，另一方面如果预留空间过多又会造成储存空间的浪费，不是一个明智的选择。

那么我们可以使用现在部分 ORM 库提供的自动迁移功能，使得预料空间可拓展，但是还是没有解决空间占用的问题。

对于可变、弹性的数据结构，我们很容易想到 JSON 这种数据格式，我们可以在数据库中将 JSON 作为拓展数据存入到表格中，并增加一个 version 字段维护数据库使用的数据版本。例如，


| id | name  | version | external                     |
| -- | ----- | ------- | ---------------------------- |
| 1  | test1 | 1       | `{"desc":"t1"}`              |
| 2  | test2 | 2       | `{"desc":"t1","uplimit":10}` |

优点在于动态拓展，新旧维持，迁移方便。但这种方式一方面牺牲了可读性，key 造成了大量冗余；另一方面，JSON 在部分数据库中查找的效率不高，JSON 内的键无法在数据库中建立索引，不适合高并发场景。

## 策略分析

显而易见的是，我们有很多针对 JSON 格式进行储存的 NoSQL 数据库，我们可以将这一部分迁移到它们上，例如 MongoDB。使用 MongoDB 能显著完善构思中最后一个方案的缺点。于是我们的最终方案就是关系型数据库结合文档型数据库的联动方式进行存储可拓展数据。

针对场景进一步分析，我们的拓展数据本质上是一份日志，并且有频繁查询近期数据的特征。于是我们可以调整数据使得数据优先从底部开始查找，并且限制用户一次性查询整个时间线记录的能力。除此之外，我们可以引用日志技术栈中经常使用的 ELK，集成 Elasticsearch 工具，以达到更强大的功能。

> 借鉴了这篇博客中的内容，并添加了一些自己的东西：[可扩展型的数据库设计-CSDN博客](https://blog.csdn.net/zyzBulus/article/details/81169733)
